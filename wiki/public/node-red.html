<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wiki Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    pre { background: #212529; color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; }
    .spinner-border { width: 1.5rem; height: 1.5rem; }
    tr:hover { background-color: #f1f3f5; cursor: pointer; }
  </style>
</head>
<body>
<div class="container py-5">
  <h1 class="text-center mb-4">ðŸ“š Wiki Space Browser</h1>

  <!-- Space Selector -->
  <div class="card p-4 mb-4">
    <h3 class="mb-3">Select Space</h3>
    <div class="d-flex gap-2">
      <select id="spaceSelect" class="form-select w-auto">
        <option value="">-- Loading spaces... --</option>
      </select>
      <button class="btn btn-primary" onclick="loadPages()">Load Pages</button>
      <div id="spaceSpinner" class="spinner-border text-primary d-none" role="status"></div>
    </div>
  </div>

  <!-- Pages Table -->
  <div class="card p-4">
    <h3 class="mb-3">Pages in Space</h3>
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Wiki Page ID</th>
            <th>Route</th>
          </tr>
        </thead>
        <tbody id="pagesTable">
          <tr><td colspan="3" class="text-muted text-center">No pages loaded yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Output Panel -->
  <div class="card p-4 mt-4">
    <h3 class="mb-3">Response</h3>
    <pre id="output">Responses will appear here...</pre>
  </div>
</div>

<script>
// API endpoints
const spacesAPI = "http://127.0.0.1:8003/api/resource/Wiki%20Space";
const pageListAPI = "http://127.0.0.1:8003/api/method/wiki.wiki.doctype.wiki_space.wiki_space.page_list_of_space";

// Auth headers
const headers = {
  "Authorization": "token 1212:1212",
  "Content-Type": "application/json",
  "Cookie": "full_name=Guest; sid=Guest; system_user=no; user_id=Guest; user_lang=en"
};

// Load spaces on page load
document.addEventListener("DOMContentLoaded", async () => {
  try {
    const res = await fetch(spacesAPI, { headers });
    const json = await res.json();
    showOutput(json);
    const select = document.getElementById("spaceSelect");
    select.innerHTML = "";
    if (json.data && Array.isArray(json.data)) {
      json.data.forEach(space => {
        const opt = document.createElement("option");
        opt.value = space.name;
        opt.textContent = space.name;
        select.appendChild(opt);
      });
    } else {
      select.innerHTML = "<option>No spaces found</option>";
    }
  } catch (err) {
    showOutput({ status: "error", message: err.message });
  }
});

// Load pages of selected space
async function loadPages() {
  const spaceId = document.getElementById("spaceSelect").value;
  if (!spaceId) {
    alert("Please select a space");
    return;
  }
  toggleSpinner(true);

  try {
    const res = await fetch(pageListAPI, {
      method: "POST", // sending JSON payload
      headers,
      body: JSON.stringify({ wiki_space_id: spaceId })
    });
    const json = await res.json();
    showOutput(json);

    const table = document.getElementById("pagesTable");
    table.innerHTML = "";

    if (json.message && Array.isArray(json.message)) {
      json.message.forEach((page, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${page.wiki_page}</td>
          <td>${page.route}</td>
        `;
        tr.addEventListener("click", () => {
          const fullUrl = "http://127.0.0.1:8003/" + page.route;
          window.open(fullUrl, "_blank");
        });
        table.appendChild(tr);
      });
    } else {
      table.innerHTML = `<tr><td colspan="3" class="text-muted text-center">No pages found</td></tr>`;
    }
  } catch (err) {
    showOutput({ status: "error", message: err.message });
  } finally {
    toggleSpinner(false);
  }
}

// Helpers
function showOutput(obj) {
  document.getElementById("output").textContent = JSON.stringify(obj, null, 2);
}
function toggleSpinner(show) {
  document.getElementById("spaceSpinner").classList.toggle("d-none", !show);
}
</script>
</body>
</html>
