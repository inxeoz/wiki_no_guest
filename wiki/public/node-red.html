<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wiki Space Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f5f7fb; }
    .card { border-radius:10px; box-shadow:0 6px 18px rgba(20,30,60,0.06); }
    tr:hover { background:#f1f4f8; cursor:pointer; }
    .btn-check + label.btn { cursor: pointer; }
    .muted { color:#6b7280; font-size:.95rem; }
  </style>
</head>
<body>
<div class="container py-5">
  <h2 class="text-center mb-4">Wiki Space Manager</h2>

  <div class="card p-4 mb-4">
    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <select id="spaceSelect" class="form-select" style="min-width:220px;">
          <option>Loading spaces...</option>
        </select>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" onclick="loadPages()">Load Pages</button>
      </div>
      <div class="col-auto">
        <input id="saveToken" class="form-control" placeholder="Token (e.g. 005)" style="min-width:180px;">
      </div>
      <div class="col-auto">
        <button class="btn btn-success" onclick="saveSelected()">Save</button>
      </div>
      <div class="col-auto">
        <button class="btn btn-warning" onclick="redirectToRoute()">Redirect</button>
      </div>
      <div class="col-auto">
        <div id="status" class="muted">Status: idle</div>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <div class="table-responsive">
      <table class="table table-borderless align-middle mb-0">
        <thead>
          <tr>
            <th style="width:4%">#</th>
            <th style="width:30%">Wiki Page ID {Space}</th>
            <th style="width:46%">Route</th>
            <th style="width:20%">Edit</th>
          </tr>
        </thead>
        <tbody id="pagesTable">
          <tr><td colspan="4" class="text-center muted py-4">No pages loaded</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const frappeBase = "http://127.0.0.1:8003";
const spacesAPI = `${frappeBase}/api/resource/Wiki%20Space?fields=["space_name","name","route"]`;
const pageListAPI = `${frappeBase}/api/method/wiki.wiki.doctype.wiki_space.wiki_space.page_list_of_space`;
const wikiRouteAPI = `${frappeBase}/api/method/wiki.wiki.doctype.wiki_page.wiki_page.wiki_route`;
const nodeRedSaveAPI = "http://127.0.0.1:1880/data";

const authHeaders = {
  "Authorization": "token 1212:1212",
  "Content-Type": "application/json",
  "Cookie": "full_name=Guest; sid=Guest; system_user=no; user_id=Guest; user_lang=en"
};

let currentPages = [];
let currentSpaceName = "";

function setStatus(text, isError=false) {
  const s = document.getElementById('status');
  s.textContent = 'Status: ' + text;
  s.style.color = isError ? 'crimson' : '#6b7280';
}
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"'`]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[m])); }

async function loadSpaces(){
  const sel = document.getElementById('spaceSelect');
  sel.innerHTML = '<option>Loading...</option>';
  try {
    const res = await fetch(spacesAPI, { headers: authHeaders });
    const json = await res.json();
    sel.innerHTML = '';
    if (json.data && Array.isArray(json.data)) {
      json.data.forEach(sp => {
        const opt = document.createElement('option');
        opt.value = sp.name;
        opt.textContent = `${sp.space_name} (${sp.route}) (${sp.name})`;
        opt.dataset.spaceName = sp.space_name;
        sel.appendChild(opt);
      });
      setStatus('spaces loaded');
    } else {
      sel.innerHTML = '<option>No spaces</option>';
      setStatus('no spaces', true);
    }
  } catch (err) {
    sel.innerHTML = '<option>Error</option>';
    setStatus('error loading spaces', true);
  }
}

async function loadPages(){
  const sel = document.getElementById('spaceSelect');
  const spaceId = sel.value;
  const spaceName = sel.options[sel.selectedIndex]?.dataset.spaceName || "";
  if (!spaceId) { setStatus('select a space', true); return; }
  currentSpaceName = spaceName;
  setStatus('loading pages...');
  const table = document.getElementById('pagesTable');
  table.innerHTML = '<tr><td colspan="4" class="text-center muted py-4">Loading...</td></tr>';

  try {
    const res = await fetch(pageListAPI, {
      method: 'POST',
      headers: authHeaders,
      body: JSON.stringify({ wiki_space_id: spaceId })
    });
    const json = await res.json();

    if (!json.message || !Array.isArray(json.message)) {
      table.innerHTML = '<tr><td colspan="4" class="text-center muted py-4">No pages</td></tr>';
      currentPages = [];
      setStatus('no pages', true);
      return;
    }

    currentPages = json.message.map(p => ({
      wiki_page_id: p.wiki_page || p.name,
      route: p.route || '',
      edit: 0
    }));
    renderTable();
    setStatus('pages loaded');
  } catch (err) {
    table.innerHTML = '<tr><td colspan="4" class="text-center muted py-4">Error loading</td></tr>';
    setStatus('error loading pages', true);
  }
}

function renderTable() {
  const table = document.getElementById('pagesTable');
  table.innerHTML = '';

  // === control row ===
  const ctrl = document.createElement('tr');
  ctrl.innerHTML = `
    <td>*</td>
    <td class="fw-bold text-primary">Bulk Toggle</td>
    <td class="text-muted">Apply to all pages</td>
    <td>
      <div class="btn-group btn-group-sm" role="group">
        <button class="btn btn-outline-success">All Visible</button>
        <button class="btn btn-outline-primary">All Editable</button>
        <button class="btn btn-outline-danger">All Hidden</button>
      </div>
    </td>
  `;
  table.appendChild(ctrl);

  // hook up buttons
  const btns = ctrl.querySelectorAll('button');
  btns[0].addEventListener('click', () => { currentPages.forEach(p => p.edit=0); renderTable(); });
  btns[1].addEventListener('click', () => { currentPages.forEach(p => p.edit=1); renderTable(); });
  btns[2].addEventListener('click', () => { currentPages.forEach(p => p.edit=-1); renderTable(); });

  // === normal page rows ===
  currentPages.forEach((p, idx) => {
    const tr = document.createElement('tr');
    const name = `edit-${idx}`;
    const idV = `v-${idx}`, idE = `e-${idx}`, idH = `h-${idx}`;
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td class="fw-semibold">${escapeHtml(p.wiki_page_id)} {${escapeHtml(currentSpaceName)}}</td>
      <td class="text-muted">${escapeHtml(p.route)}</td>
      <td>
        <div class="btn-group btn-group-sm">
          <input type="radio" class="btn-check" name="${name}" id="${idV}" ${p.edit===0?'checked':''}>
          <label class="btn btn-outline-success" for="${idV}">Visible</label>
          <input type="radio" class="btn-check" name="${name}" id="${idE}" ${p.edit===1?'checked':''}>
          <label class="btn btn-outline-primary" for="${idE}">Editable</label>
          <input type="radio" class="btn-check" name="${name}" id="${idH}" ${p.edit===-1?'checked':''}>
          <label class="btn btn-outline-danger" for="${idH}">Hidden</label>
        </div>
      </td>
    `;
    table.appendChild(tr);
    document.getElementById(idV).addEventListener('change',()=>currentPages[idx].edit=0);
    document.getElementById(idE).addEventListener('change',()=>currentPages[idx].edit=1);
    document.getElementById(idH).addEventListener('change',()=>currentPages[idx].edit=-1);
  });
}


async function saveSelected() {
  const token = document.getElementById('saveToken').value.trim();
  if (!token) { setStatus('enter token', true); return; }
  if (!currentPages.length) { setStatus('no pages', true); return; }
  setStatus('saving...');
  const pages = currentPages.map(p => ({ wiki_page_id: p.wiki_page_id, edit: p.edit }));
  try {
    const res = await fetch(nodeRedSaveAPI, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ token, data:{ pages } })
    });
    const json = await res.json();
    setStatus(json.status==='ok'?'saved':'save failed', json.status!=='ok');
  } catch (err) {
    setStatus('save error', true);
  }
}

async function redirectToRoute() {
  const token = document.getElementById('saveToken').value.trim();
  if (!token) { setStatus('enter token', true); return; }
  if (!currentPages.length) { setStatus('no pages', true); return; }
  const firstPage = currentPages[0];
  try {
    const res = await fetch(wikiRouteAPI, {
      method: 'POST',
      headers: authHeaders,
      body: JSON.stringify({ wiki_page_id: firstPage.wiki_page_id, token })
    });
    const json = await res.json();
    if (json.message) {
      const url = frappeBase.replace(/\/$/,'') + json.message;
      window.open(url, '_blank');
      setStatus('redirected');
    } else {
      setStatus('no route returned', true);
    }
  } catch (err) {
    setStatus('redirect error', true);
  }
}

document.addEventListener('DOMContentLoaded', loadSpaces);
</script>
</body>
</html>
